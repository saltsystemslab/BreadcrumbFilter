TARGETS= main_avx2 main_tx_avx2 main_id_avx2 bm_avx2

OPT=-O3 -g

ARCH=-mavx2

ifeq ($(P),1)
   OPT=-g -no-pie
endif

# HAVE_AVX512=$(filter-out 0,$(shell lscpu | grep avx512bw | wc -l))
HAVE_AVX512=0

ifeq ($(THREAD),1)
   OPT +=-DENABLE_THREADS
endif

# CXX = g++ -std=c++11 -fgnu-tm -frename-registers  -march=native
# CC = gcc -std=gnu11 -fgnu-tm -frename-registers  -march=native
CXX = g++ -std=c++11 -fgnu-tm -frename-registers  -march=x86-64-v3
CC = gcc -std=gnu11 -fgnu-tm -frename-registers  -march=x86-64-v3
LD= g++ -std=c++11

LOC_INCLUDE=include
LOC_SRC=src
OBJDIR=obj_avx2

CXXFLAGS += -Wall $(DEBUG) $(PROFILE) $(OPT) $(ARCH) -m64 -I. -I$(LOC_INCLUDE)

CFLAGS += -Wall $(DEBUG) $(PROFILE) $(OPT) $(ARCH) -m64 -I. -I$(LOC_INCLUDE)

LDFLAGS += $(DEBUG) $(PROFILE) $(OPT) -lpthread -lssl -lcrypto -lm -litm

#
# declaration of dependencies
#

all: $(TARGETS)


main_avx2:							$(OBJDIR)/main.o $(OBJDIR)/vqf_filter.o 
main_id_avx2:						$(OBJDIR)/main_id.o $(OBJDIR)/vqf_filter.o
main_tx_avx2:						$(OBJDIR)/main_tx.o $(OBJDIR)/vqf_filter.o
bm_avx2:							$(OBJDIR)/bm.o $(OBJDIR)/vqf_filter.o

# dependencies between .o files and .cc (or .c) files
$(OBJDIR)/shuffle_matrix_512_16.o: 	$(LOC_SRC)/shuffle_matrix_512_16.c
$(OBJDIR)/shuffle_matrix_512.o: 	$(LOC_SRC)/shuffle_matrix_512.c
$(OBJDIR)/main.o: 			$(LOC_SRC)/main.cc
$(OBJDIR)/main_id.o: 			$(LOC_SRC)/main_id.cc
$(OBJDIR)/main_tx.o: 			$(LOC_SRC)/main_tx.cc
$(OBJDIR)/bm.o: 			$(LOC_SRC)/bm.cc

$(OBJDIR)/vqf_filter.o: 			$(LOC_SRC)/vqf_filter.c

#
# generic build rules
#

$(TARGETS):
	$(LD) $^ $(LDFLAGS) -o $@

$(OBJDIR)/%.o: $(LOC_SRC)/%.cc | $(OBJDIR)
	$(CXX) $(CXXFLAGS) $(INCLUDE) -c -o $@ $<

$(OBJDIR)/%.o: $(LOC_SRC)/%.c | $(OBJDIR)
	$(CXX) $(CFLAGS) $(INCLUDE) -c -o $@ $<

$(OBJDIR):
	@mkdir -p $(OBJDIR)

clean:
	rm -rf $(OBJDIR) core $(TARGETS)

